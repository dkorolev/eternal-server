<!doctype html>

<head>
  <title>Eternal</title>
  <link rel='icon' type='image/x-icon' href='/favicon.ico'>
  <meta name='referrer' content='no-referrer' />
</head>


<body style='margin:0px;padding:0px;overflow:hidden'>
  <table cellpadding=10px cellspacing=0 border=0 style='position:absolute; height:100%; width:100%;' />
    <tr height=1 bgcolor=lightgrey>
      <td align=right>Eternal server | v0.1</td>
    </tr>
    <tr height=100%>
      <td valign=top style='margin:0px;padding:7px;overflow:hidden'>
        <iframe id='dynamic_iframe' src='/frame.html' frameborder=0 width='100%' height='100%' title='Dynamic Content'></iframe>
      </td>
    </tr>
    <tr height=1 bgcolor=lightgrey>
      <td align=right>Inner frame | blah</td>
    </tr>
  </table>

  <script>
    let n = 0;
    let lastPingN = null;
    let lastPingTs = null;

    let connectedWs = null;
    const token = {
      virtue: null,
      cookie: null,
    };

    let iframeSignature = null;
    let wsSentIframeSignature = null;
    window.document.addEventListener('signatureFromIFrame', (e) => {
      iframeSignature = e.detail.signature;
      if (connectedWs && token.virtue && token.cookie && iframeSignature !== wsSentIframeSignature) {
        connectedWs.send(JSON.stringify({virtue: token.virtue, cmd: 'signature', n: ++n, signature: iframeSignature}));
        wsSentIframeSignature = iframeSignature;
      }
    }, false);

    const version = '___SHA256___';

    const genRandomString = () => {
      return crypto.getRandomValues(new Uint32Array(16)).join('-');
    };

    const computeSHA256 = async (text) => {
      view = new DataView(await crypto.subtle.digest('SHA-256', (new TextEncoder('utf-8')).encode(text)));
      let hexes = [];
      for (let i = 0; i < view.byteLength && i < 8; i += 4) {
        hexes.push(('00000000' + view.getUint32(i).toString(16)).slice(-8));
      }
      return hexes.join('');
    };

    const asyncInitWithRandoms = async () => {
      const virtue = await computeSHA256(genRandomString());
      const cookie = localStorage.getItem('NONCE');
      if (cookie !== null) {
        return {virtue, cookie, cached: true};
      } else {
        const newCookie = await computeSHA256(genRandomString());
        localStorage.setItem('NONCE', newCookie);
        return {virtue, cookie: newCookie, cached: false};
      }
    };

    let pingTime = 0;
    asyncInitWithRandoms().then((retval) => {
      token.virtue = retval.virtue;
      token.cookie = retval.cookie;

      // TODO(dkorolev): This has to come from an env var, replaced in a way similar to `___SHA256___`.
      let ws = new WebSocket('ws://localhost:5000/_next/webpack-hmr');

      ws.onopen = () => {
        const sendPing = () => {
          lastPingN = ++n;
          lastPingTs = Date.now();
          ws.send(JSON.stringify({cmd: 'ping', n: lastPingN, ts: lastPingTs}));
        };
        ws.send(JSON.stringify({virtue: token.virtue, cmd: 'identify', cookie: token.cookie, ua: navigator.userAgent}));
        // pingTime = Date.now();
        // ws.send(JSON.stringify({virtue: token.virtue, cookie: token.cookie, cmd: 'ping', n: ++n, ua: navigator.userAgent, ts: pingTime}));
        connectedWs = ws;
        if (iframeSignature && iframeSignature !== wsSentIframeSignature) {
          connectedWs.send(JSON.stringify({virtue: token.virtue, cmd: 'signature', n: ++n, signature: iframeSignature}));
          wsSentIframeSignature = iframeSignature;
        }
        sendPing();
        const intervalNonce = setInterval(() => {
          if (ws) {
            sendPing();
          } else {
            clearInterval(intervalNonce);
          }
        }, 5000);
      };

      ws.onclose = () => {
        console.log('websocket closed');
        ws = null;
      };

      ws.onmessage = (e) => {
        try {
          const json = JSON.parse(e.data);
          if (typeof json === 'object') {
            if (json.cmd === 'pong') {
              const now = Date.now();
              if (json.n === lastPingN) {
                console.log(`Ping: ${Date.now() - lastPingTs}ms`);
              } else {
                console.log(`Received an out-of-order ping reply, ${json.n} != ${lastPingN}.`);
              }
            } else if (json.cmd === 'sping') {
              ws.send(JSON.stringify({cmd: 'spong', m: json.m, ts: Date.now()}));
            } else if (json.cmd === 'reload') {
              iframeSignature = null;
              const f = document.getElementById('dynamic_iframe');
              f.src = f.src;
            }
          }
        } catch (ex) {
          console.log(`Malformed message from server: ${JSON.stringify(e.data)}.`);
        }
      }
    });
  </script>
</body>
