<!doctype html>

<head>
  <title>Eternal</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <meta name='referrer' content='no-referrer' />
</head>

<body>
  <pre><div id='browser'>Browser: ...</div></pre>
  <pre><div id='nonce'>Nonce: ...</div></pre>
  <h3>This content is outside the IFRAME</h3>
  Custom text outside the IFRAME.
  <iframe id='dynamic_iframe' src='/frame.html' frameborder=0 width=100% height=10000px title='Dynamic Content'></iframe>
  <script>
    let iframeSignature = null;
    window.document.addEventListener('signatureFromIFrame', (e) => { iframeSignature = e.detail.signature; }, false);

    let n = 0;
    const version = '___SHA256___';
    document.getElementById('browser').innerText = 'Browser: ' + navigator.userAgent;
    const computeSHA256 = async (text) => {
      view = new DataView(await crypto.subtle.digest('SHA-256', (new TextEncoder('utf-8')).encode(text)));
      let hexes = [];
      for (let i = 0; i < view.byteLength && i < 8; i += 4) {
        hexes.push(('00000000' + view.getUint32(i).toString(16)).slice(-8));
      }
      return hexes.join('');
    };
    let pingTime = 0;
    const getPersistedNonce = async () => {
      const nonce = localStorage.getItem('NONCE');
      if (nonce !== null) {
        return {nonce, cached: true};
      } else {
        const newNonce = await computeSHA256(crypto.getRandomValues(new Uint32Array(16)).join('-'));
        localStorage.setItem('NONCE', newNonce);
        return {nonce: newNonce, cached: false};
      }
    };
    getPersistedNonce().then((nonce) => {
      document.getElementById('nonce').innerText = 'Nonce: ' + nonce.nonce + (!nonce.cached ? ' (freshly generated)' : '');
      // TODO(dkorolev): This has to come from an env var, replaced in a way similar to `___SHA256___`.
      // const ws = new WebSocket('ws://localhost:9877/');
      const ws = new WebSocket('ws://localhost:5000/_next/webpack-hmr');
      ws.onopen = () => {
        pingTime = Date.now();
        ws.send(JSON.stringify({nonce: nonce.nonce, cmd: 'ping', n: ++n, us: navigator.userAgent, ts: pingTime}));
      };
      ws.onmessage = (e) => {
        try {
          const json = JSON.parse(e.data);
          if (typeof json === 'object') {
            if (json.cmd === 'pong') {
              const now = Date.now();
              console.log(`Ping: ${now - pingTime}ms, time skew: ${json.ts - pingTime}ms.`);
            } else if (json.cmd === 'reload') {
              iframeSignature = null;
              const f = document.getElementById('dynamic_iframe');
              f.src = f.src;
            }
          }
        } catch (ex) {
          console.log(`Malformed message from server: ${JSON.stringify(e.data)}.`);
        }
      }
    });
  </script>
</body>
